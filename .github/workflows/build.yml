name: build

on: 
  workflow_dispatch:
  push:
      tags:
        - 'v*'

permissions:
  # needed for later attachment to github release
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
        # python-version currently ignored by local setup action
        python-version: ["3.12"]
        include:
          - os: ubuntu-latest
            platform_slug: linux-x86_64
            archive_ext: tar.gz
            VSCODE_CLI_BIN: ./vscode/VSCode-linux-x64/bin/code
            VSCODE_USER_DATA: vscode/VSCode-linux-x64/data/user-data/User
            VSCODE_START_SCRIPT: Start_VSCode.sh
            PYTHON_BIN: ./pyinst/cpython-3.12.12-linux-x86_64-gnu/bin/python3

          - os: macos-14
            platform_slug: macos-arm64
            archive_ext: zip
            VSCODE_CLI_BIN: ./vscode/Visual Studio Code.app/Contents/Resources/app/bin/code
            VSCODE_USER_DATA: vscode/code-portable-data/user-data/User
            VSCODE_START_SCRIPT: Start_VSCode.sh

          - os: windows-latest
            platform_slug: windows-x86_64
            archive_ext: zip
            VSCODE_CLI_BIN: vscode/bin/code.cmd
            VSCODE_USER_DATA: vscode/data/user-data/User
            VSCODE_START_SCRIPT: Start_VSCode.cmd

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup/
        with:
          python-version: ${{ matrix.python-version }}
      - name: shell
        shell: bash
        #TODO: cleanup and harmonization
        run: |
          pwd
          ls -alR
          echo $PATH
          export PATH="${GITHUB_WORKSPACE}/uv:$PATH"
          echo $PATH
          uv python find
          uv python list
    
      - name: linux/mac install python libs
        if: runner.os != 'Windows'
        shell: bash
        run: |
          export PATH="${GITHUB_WORKSPACE}/uv:$PATH"
          rm ./pyinst/cpython-3.*/lib/python3.*/EXTERNALLY-MANAGED
          uv pip install build123d ocp_vscode git+https://github.com/GarryBGoode/gggears --python ./pyinst/cpython-3*

      - name: windows install python libs
        if: runner.os == 'Windows'
        shell: bash
        run: |
          export PATH="${GITHUB_WORKSPACE}/uv:$PATH"
          rm ./pyinst/cpython-3.*/Lib/EXTERNALLY-MANAGED
          uv pip install build123d ocp_vscode git+https://github.com/GarryBGoode/gggears --python ./pyinst/cpython-3*

      - name: linux get VSCode
        if: runner.os == 'Linux'
        shell: bash
        run: |
          curl -L -o vscode.tar.gz https://update.code.visualstudio.com/latest/linux-x64/stable
          mkdir -p ${{ matrix.VSCODE_USER_DATA }}/snippets/
          tar -zxf vscode.tar.gz -C vscode/
          chmod +x ${{ matrix.VSCODE_CLI_BIN }}
          
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension ms-python.python
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension ms-toolsai.jupyter
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension ms-python.black-formatter
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension bernhard-42.ocp-cad-viewer
          
          cp scripts/${{ matrix.VSCODE_START_SCRIPT }} ./
          chmod +x ${{ matrix.VSCODE_START_SCRIPT }}
          
          cp scripts/settings.json ${{ matrix.VSCODE_USER_DATA }}/
          cp scripts/build123d-OCP.code-snippets ${{ matrix.VSCODE_USER_DATA }}/snippets/

      - name: macos get VSCode
        if: runner.os == 'macOS'
        shell: bash
        run: |
          curl -L -o vscode.zip https://update.code.visualstudio.com/latest/darwin-universal/stable
          mkdir -p ${{ matrix.VSCODE_USER_DATA }}/snippets/
          unzip -q vscode.zip -d vscode/
          
          "${{ matrix.VSCODE_CLI_BIN }}" --install-extension ms-python.python
          "${{ matrix.VSCODE_CLI_BIN }}" --install-extension ms-toolsai.jupyter
          "${{ matrix.VSCODE_CLI_BIN }}" --install-extension ms-python.black-formatter
          "${{ matrix.VSCODE_CLI_BIN }}" --install-extension bernhard-42.ocp-cad-viewer
          
          cp scripts/${{ matrix.VSCODE_START_SCRIPT }} ./
          
          cp scripts/settings.json ${{ matrix.VSCODE_USER_DATA }}/
          cp scripts/build123d-OCP.code-snippets ${{ matrix.VSCODE_USER_DATA }}/snippets/

          # now we remove vscode itself (but keep settings and extensions)
          # for user to later install themselves this is because VSCode is 
          # signed by Micrsoft, and this will prevent
          # quarantining issues for the end user
          rm -rf vscode/"Visual Studio Code.app"

      - name: windows get VSCode
        if: runner.os == 'Windows'
        shell: bash
        run: |
          curl -o vscode.zip -LsSf https://update.code.visualstudio.com/latest/win32-x64-archive/stable
          mkdir -p ${{ matrix.VSCODE_USER_DATA }}/snippets/
          unzip -q vscode.zip -d vscode/
          
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension ms-python.python
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension ms-toolsai.jupyter
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension ms-python.black-formatter
          ${{ matrix.VSCODE_CLI_BIN }} --install-extension bernhard-42.ocp-cad-viewer
          
          cp scripts/${{ matrix.VSCODE_START_SCRIPT }} ./
          
          cp scripts/settings.json ${{ matrix.VSCODE_USER_DATA }}/
          cp scripts/build123d-OCP.code-snippets ${{ matrix.VSCODE_USER_DATA }}/snippets/

      - name: Generate Version Report
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # 1. Define Paths to your local binaries
          # Note: We use the exact paths created in your previous steps
          PYTHON_BIN=${{ matrix.PYTHON_BIN }}
          
          # 2. Get Standalone Python Version
          # Output: "Python 3.12.12" -> Extract "3.12.12"
          PY_RAW=$($PYTHON_BIN --version)
          PY_VER=${PY_RAW#Python }

          # 3. Get Python Package Versions (using pip show)
          # We grab the line "Version: x.y.z" and cut out the number
          B123_VER=$($PYTHON_BIN -m pip show build123d | grep "^Version:" | cut -d ' ' -f 2)
          GGGEARS_VER=$($PYTHON_BIN -m pip show gggears | grep "^Version:" | cut -d ' ' -f 2)

          # 4. Get VSCode Version
          # "code --version" outputs 3 lines: version, commit, arch. We take line 1.
          CODE_VER=$(${{ matrix.VSCODE_CLI_BIN }} --version | head -n 1)

          # 5. Get Extension Versions
          # "code --list-extensions --show-versions" returns "publisher.ext@version"
          # We capture the output once to avoid relaunching VSCode multiple times
          EXTS_OUT=$(${{ matrix.VSCODE_CLI_BIN }} --list-extensions --show-versions)
          
          # Parse specific versions
          OCP_VER=$(echo "$EXTS_OUT" | grep "bernhard-42.ocp-cad-viewer" | cut -d '@' -f 2)
          MSPY_VER=$(echo "$EXTS_OUT" | grep "ms-python.python@" | cut -d '@' -f 2)
          JUP_VER=$(echo "$EXTS_OUT" | grep "ms-toolsai.jupyter@" | cut -d '@' -f 2)
          BLK_VER=$(echo "$EXTS_OUT" | grep "ms-python.black-formatter" | cut -d '@' -f 2)

          # 6. Construct and Print the Release Note String
          # We define a multiline string variable for clarity
          read -r -d '' RELEASE_NOTE_BLOCK << EOM
          - Standalone Python $PY_VER
          - build123d v$B123_VER
          - gggears v$GGGEARS_VER
          - VSCode v$CODE_VER -- with VSCode extensions:
            - OCP CAD Viewer v$OCP_VER
            - Microsoft Python v$MSPY_VER
            - Microsoft Jupyter v$JUP_VER
            - Microsoft Black Formatter v$BLK_VER
          EOM

          # Print to Console Logs
          echo "---------------------------------------------------"
          echo "GENERATED RELEASE NOTES:"
          echo "$RELEASE_NOTE_BLOCK"
          echo "---------------------------------------------------"

          # Save to GitHub Step Summary (Visible in Actions UI)
          echo "### Component Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$RELEASE_NOTE_BLOCK" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v6
        with:
          name: build123d-portable-${{ matrix.os }}
          # TODO: make cross-platform compat
          include-hidden-files: true # This line is crucial for including hidden files
          path: |
            pyinst/
            python/
            uv/
            vscode/
            ${{ matrix.VSCODE_START_SCRIPT }}
            *.sh

      - name: Create Release Archive
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          # 1. Define the Release Filename
          ASSET_NAME="build123d-portable_${{ github.ref_name }}-${{ matrix.platform_slug }}.${{ matrix.archive_ext }}"
          echo "RELEASE_ASSET_FILE=$ASSET_NAME" >> $GITHUB_ENV
          
          # 2. Define what to include (Folders + Launcher Scripts)
          # Using a wildcard for the script ensures we catch .cmd or .sh depending on what exists
          FILES_TO_PACK="uv pyinst python vscode Start_VSCode.*"

          # 3. Compress based on extension
          if [ "${{ matrix.archive_ext }}" == "tar.gz" ]; then
            # Linux: Create .tar.gz
            tar -czf "$ASSET_NAME" $FILES_TO_PACK
          else
            # Windows/Mac: Create .zip
            if [ "$RUNNER_OS" == "Windows" ]; then
              7z a -tzip "$ASSET_NAME" $FILES_TO_PACK
            else
              # MacOS Zip with extra vscode install script
              FILES_TO_PACK = "${FILES_TO_PACK} macos-install-vscode.sh"
              zip -r -q "$ASSET_NAME" $FILES_TO_PACK
            fi
          fi

      - name: Upload Binary to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.RELEASE_ASSET_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
