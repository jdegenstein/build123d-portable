name: build

on: 
  workflow_dispatch:
  push:
      tags:
        - 'v*'

permissions:
  # needed for later attachment to github release
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
        # currently ignored by local setup action
        python-version: ["3.12"]
        include:
          - os: ubuntu-latest
            platform_slug: linux-x86_64
            archive_ext: tar.gz

          - os: macos-14
            platform_slug: macos-arm64
            archive_ext: zip

          - os: windows-latest
            platform_slug: windows-x86_64
            archive_ext: zip

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup/
        with:
          python-version: ${{ matrix.python-version }}
      - name: shell
        shell: bash
        #TODO: cleanup and harmonization
        run: |
          pwd
          ls -alR
          echo $PATH
          export PATH="${GITHUB_WORKSPACE}/uv:$PATH"
          echo $PATH
          uv python find
          uv python list
    
      - name: linux/mac install python libs
        if: runner.os != 'Windows'
        shell: bash
        run: |
          export PATH="${GITHUB_WORKSPACE}/uv:$PATH"
          rm ./pyinst/cpython-3.*/lib/python3.*/EXTERNALLY-MANAGED
          uv pip install build123d ocp_vscode git+https://github.com/GarryBGoode/gggears --python ./pyinst/cpython-3*

      - name: windows install python libs
        if: runner.os == 'Windows'
        shell: bash
        run: |
          export PATH="${GITHUB_WORKSPACE}/uv:$PATH"
          rm ./pyinst/cpython-3.*/Lib/EXTERNALLY-MANAGED
          uv pip install build123d ocp_vscode git+https://github.com/GarryBGoode/gggears --python ./pyinst/cpython-3*

      - name: linux get VSCode
        if: runner.os == 'Linux'
        shell: bash
        run: |
          curl -L -o vscode.tar.gz https://update.code.visualstudio.com/latest/linux-x64/stable
          mkdir vscode/
          tar -zxf vscode.tar.gz -C vscode/
          mkdir vscode/VSCode-linux-x64/data
          ls -alR
          chmod +x vscode/VSCode-linux-x64/code
          chmod +x vscode/VSCode-linux-x64/bin/code
          
          ./vscode/VSCode-linux-x64/bin/code --install-extension ms-python.python
          ./vscode/VSCode-linux-x64/bin/code --install-extension ms-toolsai.jupyter
          ./vscode/VSCode-linux-x64/bin/code --install-extension ms-python.black-formatter
          ./vscode/VSCode-linux-x64/bin/code --install-extension bernhard-42.ocp-cad-viewer
          
          MY_SCRIPT="Start_VSCode.sh"
          echo "VSCODE_START_SCRIPT=$MY_SCRIPT" >> $GITHUB_ENV
          cp scripts/$MY_SCRIPT ./
          chmod +x $MY_SCRIPT
          
          mkdir -p vscode/VSCode-linux-x64/data/user-data/User/snippets/
          cp scripts/settings.json vscode/VSCode-linux-x64/data/user-data/User/
          cp scripts/build123d-OCP.code-snippets vscode/VSCode-linux-x64/data/user-data/User/snippets/

      - name: macos get VSCode
        if: runner.os == 'macOS'
        shell: bash
        run: |
          curl -L -o vscode.zip https://update.code.visualstudio.com/latest/darwin-universal/stable
          mkdir vscode
          unzip -q vscode.zip -d vscode/
          mkdir -p vscode/code-portable-data
          
          VSCODE_CLI="./vscode/Visual Studio Code.app/Contents/Resources/app/bin/code"
          "$VSCODE_CLI" --install-extension ms-python.python
          "$VSCODE_CLI" --install-extension ms-toolsai.jupyter
          "$VSCODE_CLI" --install-extension ms-python.black-formatter
          "$VSCODE_CLI" --install-extension bernhard-42.ocp-cad-viewer
          
          MY_SCRIPT="Start_VSCode.sh"
          echo "VSCODE_START_SCRIPT=$MY_SCRIPT" >> $GITHUB_ENV
          cp scripts/$MY_SCRIPT ./
          cp scripts/macos-install-vscode.sh ./
          
          mkdir -p vscode/code-portable-data/user-data/User/snippets/
          cp scripts/settings.json vscode/code-portable-data/user-data/User/
          cp scripts/build123d-OCP.code-snippets vscode/code-portable-data/user-data/User/snippets/

          # now we remove vscode itself (but keep settings and extensions)
          # for user to later install themselves this is because VSCode is 
          # signed by Micrsoft, and this will prevent
          # quarantining issues for the end user
          rm -rf vscode/"Visual Studio Code.app"
          
      - name: windows get VSCode
        if: runner.os == 'Windows'
        shell: bash
        run: |
          curl -o vscode.zip -LsSf https://update.code.visualstudio.com/latest/win32-x64-archive/stable
          unzip -q vscode.zip -d vscode/
          mkdir vscode/data
          ls -alR
          vscode/bin/code.cmd --install-extension ms-python.python
          vscode/bin/code.cmd --install-extension ms-toolsai.jupyter
          vscode/bin/code.cmd --install-extension ms-python.black-formatter
          vscode/bin/code.cmd --install-extension bernhard-42.ocp-cad-viewer
          MY_SCRIPT="Start_VSCode.cmd"
          echo "VSCODE_START_SCRIPT=$MY_SCRIPT" >> $GITHUB_ENV
          cp scripts/$MY_SCRIPT ./
          mkdir -p vscode/data/user-data/User/snippets/
          cp scripts/settings.json vscode/data/user-data/User/

      - uses: actions/upload-artifact@v6
        with:
          name: build123d-portable-${{ matrix.os }}
          # TODO: make cross-platform compat
          include-hidden-files: true # This line is crucial for including hidden files
          path: |
            pyinst/
            python/
            uv/
            vscode/
            ${{ env.VSCODE_START_SCRIPT }}
            *.sh

      - name: Create Release Archive
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          # 1. Define the Release Filename
          ASSET_NAME="build123d-portable_${{ github.ref_name }}-${{ matrix.platform_slug }}.${{ matrix.archive_ext }}"
          echo "RELEASE_ASSET_FILE=$ASSET_NAME" >> $GITHUB_ENV
          
          # 2. Define what to include (Folders + Launcher Scripts)
          # Using a wildcard for the script ensures we catch .cmd or .sh depending on what exists
          FILES_TO_PACK="uv pyinst python vscode Start_VSCode.*"

          # 3. Compress based on extension
          if [ "${{ matrix.archive_ext }}" == "tar.gz" ]; then
            # Linux: Create .tar.gz
            tar -czf "$ASSET_NAME" $FILES_TO_PACK
          else
            # Windows/Mac: Create .zip
            if [ "$RUNNER_OS" == "Windows" ]; then
              7z a -tzip "$ASSET_NAME" $FILES_TO_PACK
            else
              # MacOS Zip with extra vscode install script
              zip -r -q "$ASSET_NAME" $FILES_TO_PACK macos-install-vscode.sh
            fi
          fi

      - name: Upload Binary to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.RELEASE_ASSET_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
